name: Backend Docker Build

on:
  push:
    branches:
      - "**"
    paths:
      - "api/**"
      - "infra/**"
      - "Dockerfile"
      - "pyproject.toml"
      - "uv.lock"
      - ".github/workflows/main.yml"
  pull_request:
    branches:
      - "**"
    types: [opened, synchronize, reopened, ready_for_review]

env:
  GCP_PROJECT_ID: dataascode
  GCP_ZONE: europe-west1
  GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
  IMAGE_NAME: event-driven
  REPO_ARTIFACTORY: event-driven-gcp
  TARGET_RESSOURCE_TERRAFORM_ARTIFACT_REGISTRY: module.artifactory
  GKE_CLUSTER_NAME: template-gke-cluster

jobs:
  tests-and-type-check:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.13"]
      fail-fast: false
    defaults:
      run:
        shell: bash
    steps:
      - name: Check out
        uses: actions/checkout@v4

      - name: Set up the environment
        uses: ./.github/actions/setup-python-env
        with:
          python-version: ${{ matrix.python-version }}

      - name: Run tests
        run: uv run python -m pytest tests --cov --cov-config=pyproject.toml --cov-report=xml

      - name: Check typing
        run: uv run ty check


      - name: Upload coverage reports to Codecov with GitHub Action on Python 3.13
        uses: codecov/codecov-action@v4
        if: ${{ matrix.python-version == '3.13' }}
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}


  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Calculate Namespace
        id: ns
        run: |
          # Determine the reference name (branch name)
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            REF_NAME="${{ github.head_ref }}"
          else
            REF_NAME="${{ github.ref_name }}"
          fi

          if [ "$REF_NAME" == "main" ]; then
            echo "namespace=default" >> $GITHUB_OUTPUT
            echo "register_dns=true" >> $GITHUB_OUTPUT
          else
            # Sanitize branch name: lowercase, replace / with -, remove invalid chars
            SANITIZED_NAME=$(echo "$REF_NAME" | tr '[:upper:]' '[:lower:]' | tr '/' '-' | sed 's/[^a-z0-9-]//g')
            echo "namespace=$SANITIZED_NAME" >> $GITHUB_OUTPUT
            echo "register_dns=false" >> $GITHUB_OUTPUT
          fi

      # Authenticate with Google Cloud
      - name: Authenticate with Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # Configure Docker to use the gcloud command-line tool as a credential
      # helper for authentication
      - run: |-
          gcloud --quiet auth configure-docker ${{ env.GCP_ZONE}}-docker.pkg.dev --project=${{ env.GCP_PROJECT_ID }}

      # Installation for terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.12.1

      # Initialisation of terraform
      - name: Terraform init
        run: |
          terraform -chdir=infra/terraform init -upgrade -backend-config="backend/main.gcs.backend"

      # Plannification of terraform
      - name: Terraform plan for artifatory
        run: |
          terraform -chdir=infra/terraform plan -var-file="tfvars/main.tfvars" \
          -target=${{ env.TARGET_RESSOURCE_TERRAFORM_ARTIFACT_REGISTRY }} \
          -var "eventarc_trigger_namespace=${{ steps.ns.outputs.namespace }}" \
          -lock=false

      # Deployement of terraform
      - name: Terraform apply for for artifatory
        run: |
          terraform -chdir=infra/terraform apply -var-file="tfvars/main.tfvars" --auto-approve \
          -target=${{ env.TARGET_RESSOURCE_TERRAFORM_ARTIFACT_REGISTRY }} \
          -var "eventarc_trigger_namespace=${{ steps.ns.outputs.namespace }}" \
          -lock=false

      # Génération du tag avec la date
      - name: Generate date tag
        id: date_tag
        run: echo "date=$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT

      # Build the artifact
      - name: Docker Build
        run: |
          docker build . \
          -t ${{ env.IMAGE_NAME }}:${GITHUB_SHA::7} \
          --platform linux/amd64

      # Tag the artifact avec plusieurs tags
      - name: Docker Tag
        run: |
          IMAGE_BASE=${{ env.GCP_ZONE}}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.REPO_ARTIFACTORY }}/${{ env.IMAGE_NAME }}
          docker tag ${{ env.IMAGE_NAME }}:${GITHUB_SHA::7} ${IMAGE_BASE}:${GITHUB_SHA::7}
          docker tag ${{ env.IMAGE_NAME }}:${GITHUB_SHA::7} ${IMAGE_BASE}:${{ steps.date_tag.outputs.date }}
          docker tag ${{ env.IMAGE_NAME }}:${GITHUB_SHA::7} ${IMAGE_BASE}:latest

      # Publish the artifact avec tous les tags
      - name: Docker Publish
        run: |
          IMAGE_BASE=${{ env.GCP_ZONE}}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.REPO_ARTIFACTORY }}/${{ env.IMAGE_NAME }}
          docker push ${IMAGE_BASE}:${GITHUB_SHA::7}
          docker push ${IMAGE_BASE}:${{ steps.date_tag.outputs.date }}
          docker push ${IMAGE_BASE}:latest

      # Deployment of terraform infrastructure (without eventarc - needs K8s service first)
      - name: Terraform apply infrastructure
        run: |
          terraform -chdir=infra/terraform apply -var-file="tfvars/main.tfvars" --auto-approve \
          -var "eventarc_trigger_namespace=${{ steps.ns.outputs.namespace }}" \
          -target=module.network \
          -target=module.security \
          -target=module.service-account \
          -target=module.gke-cluster \
          -target=module.cloud-dns \
          -target=module.pubsub \
          -lock=false

      - name: Get GKE Credentials
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER_NAME }} --zone ${{ env.GCP_ZONE }} --project ${{ env.GCP_PROJECT_ID }}

      - name: Helm deployment
        run: |
          NAMESPACE="${{ steps.ns.outputs.namespace }}"
          echo "Deploying to namespace: $NAMESPACE"

          helm upgrade --install event-driven-api infra/helm \
          --namespace $NAMESPACE \
          --create-namespace \
          --set image.repository=${{ env.GCP_ZONE}}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.REPO_ARTIFACTORY }}/${{ env.IMAGE_NAME }} \
          --set image.tag=${GITHUB_SHA::7} \
          --set ingress.registerDns=${{ steps.ns.outputs.register_dns }} \
          --values infra/helm/values.yaml

      # Wait for K8s service to be ready
      - name: Wait for service readiness
        run: |
          kubectl wait --for=condition=available deployment/event-driven-api \
          --namespace=${{ steps.ns.outputs.namespace }} --timeout=300s

      # Deployment of eventarc (after K8s service is ready)
      - name: Terraform apply eventarc
        run: |
          terraform -chdir=infra/terraform apply -var-file="tfvars/main.tfvars" --auto-approve \
          -var "eventarc_trigger_namespace=${{ steps.ns.outputs.namespace }}" \
          -target=module.eventarc \
          -lock=false


  quality:
    runs-on: ubuntu-latest
    steps:
      - name: Check out
        uses: actions/checkout@v4

      - uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ hashFiles('.pre-commit-config.yaml') }}

      - name: Set up the environment
        uses: ./.github/actions/setup-python-env

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.12.1

      - name: Install terraform-docs
        run: |
          curl -sSLo terraform-docs.tar.gz https://terraform-docs.io/dl/v0.19.0/terraform-docs-v0.19.0-linux-amd64.tar.gz
          tar -xzf terraform-docs.tar.gz
          sudo mv terraform-docs /usr/local/bin/
          rm terraform-docs.tar.gz

      - name: Install hadolint
        run: |
          curl -sSL https://github.com/hadolint/hadolint/releases/download/v2.12.0/hadolint-Linux-x86_64 -o hadolint
          chmod +x hadolint
          sudo mv hadolint /usr/local/bin/

      - name: Run checks
        run: make check
        env:
          SKIP: infracost_breakdown
