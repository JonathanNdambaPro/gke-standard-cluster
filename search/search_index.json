{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"Event-Driven GCP \ud83d\ude80","text":"<p>An event-driven architecture implementation on Google Cloud Platform that ingests CloudEvents from Pub/Sub and stores them in Delta Lake format on GCS.</p> <ul> <li>Github repository: https://github.com/jojo/event-driven-gcp/</li> <li>Documentation: https://jojo.github.io/event-driven-gcp/</li> </ul>"},{"location":"#features","title":"Features","text":"<ul> <li>\u2728 CloudEvent Ingestion: Receive and process CloudEvents via Google Cloud Pub/Sub</li> <li>\ud83d\uddc4\ufe0f Delta Lake Storage: ACID-compliant storage with merge and time-travel capabilities</li> <li>\ud83d\udd04 Content-Based Deduplication: Hash-based unique ID generation to prevent duplicate events</li> <li>\u26a1 Auto-Optimization: Automatic table compaction and vacuum after ingestion</li> <li>\ud83d\udc3b\u200d\u2744\ufe0f Polars Integration: High-performance DataFrame operations for data processing</li> <li>\ud83d\udcca Observability: Structured logging with Logfire and Loguru integration</li> <li>\ud83d\udd10 Secret Management: Secure token storage via Google Secret Manager</li> <li>\ud83c\udfd7\ufe0f Infrastructure as Code: Complete Terraform modules for GCP deployment</li> <li>\ud83d\udc33 Docker Compose: Local development with GCP credentials volume mounting</li> <li>\ud83c\udfaf Event-Driven Architecture: Native Cloud Run service integration with Eventarc</li> <li>\ud83d\udee1\ufe0f Secure Storage: GCS access with least-privilege IAM policies</li> <li>\u26a1 Ephemeral Environments: Automatic per-PR environment creation on Shared Cluster</li> <li>\ud83e\udde9 Shared Infrastructure: Efficient resource usage with consolidated GKE/VPC</li> <li>\u23f1\ufe0f Temporal Cloud: Durable workflow orchestration with ephemeral workers</li> <li>\ud83d\udd01 Ephemeral Workers: Workers start/stop per request for efficient resource usage</li> </ul>"},{"location":"#architecture","title":"Architecture","text":"<pre><code>graph TD\n    subgraph GCP[\"Google Cloud Platform\"]\n        subgraph SharedInfra[\"Shared Infrastructure (Prod)\"]\n            VPC[\"VPC Network\"]\n            DNS[\"Cloud DNS\"]\n            GKE[\"GKE Cluster Autopilot\"]\n        end\n\n        subgraph EventFlow[\"Event Driven Architecture\"]\n            PubSub[\"Pub/Sub Topic\"]\n            Eventarc[\"Eventarc Trigger\"]\n        end\n\n        subgraph App[\"Application Layer\"]\n            Service[\"K8s Service (Cloud Run)\"]\n            Pods[\"FastAPI Pods\"]\n            Delta[\"Delta Lake (GCS)\"]\n            Logfire[\"Logfire Observability\"]\n        end\n    end\n\n    %% Relationships\n    PubSub --&gt;|Push| Eventarc\n    Eventarc --&gt;|Trigger| Service\n    Service --&gt; Pods\n    Pods --&gt;|Write| Delta\n    Pods --&gt;|Log| Logfire\n\n    %% Styling\n    classDef shared fill:#e1f5fe,stroke:#01579b,stroke-width:2px,color:#000;\n    classDef event fill:#fff3e0,stroke:#ff6f00,stroke-width:2px,color:#000;\n    classDef app fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px,color:#000;\n\n    class VPC,DNS,GKE shared;\n    class PubSub,Eventarc event;\n    class Service,Pods,Delta,Logfire app;</code></pre> <p>The system follows an event-driven pattern where:</p> <ol> <li>Events are published to a Pub/Sub topic</li> <li>Eventarc triggers the GKE service via native integration</li> <li>FastAPI API receives and validates the CloudEvent</li> <li>Data is decoded from base64 and parsed as JSON</li> <li>A unique ID is generated using SHA256 hash of event content</li> <li>Data is validated with Pydantic models</li> <li>Temporal Workflow is triggered with ephemeral worker</li> <li>Events are processed and upserted into Delta Lake tables on GCS</li> <li>Tables are automatically optimized (compact + vacuum)</li> <li>Worker shuts down and response is returned</li> </ol>"},{"location":"#quick-start","title":"Quick Start","text":""},{"location":"#prerequisites","title":"Prerequisites","text":"<ul> <li>Python 3.11+</li> <li>uv package manager</li> <li>Google Cloud SDK (for deployment)</li> <li>Terraform (for infrastructure)</li> </ul>"},{"location":"#local-development","title":"Local Development","text":"<ol> <li> <p>Clone the repository <pre><code>git clone https://github.com/jojo/event-driven-gcp.git\ncd event-driven-gcp\n</code></pre></p> </li> <li> <p>Install dependencies <pre><code>make install\n</code></pre></p> </li> <li> <p>Run the API locally (with Docker Compose)</p> </li> </ol> <pre><code>docker compose up --build\n</code></pre> <p>This mounts your GCP credentials automatically from <code>~/.config/gcloud/application_default_credentials.json</code>.</p> <ol> <li>Or run without Docker</li> </ol> <pre><code>uv run uvicorn api.app:app --reload\n</code></pre> <ol> <li>Run tests</li> </ol> <pre><code>make test\n</code></pre>"},{"location":"#infrastructure-deployment","title":"Infrastructure Deployment","text":"<ol> <li> <p>Configure GCP backend <pre><code>cd infra\n# Edit backend configuration\nterraform init -backend-config=backend/dev.gcs.backend\n</code></pre></p> </li> <li> <p>Deploy infrastructure <pre><code>terraform plan\nterraform apply\n</code></pre></p> </li> <li> <p>Deploy the API <pre><code>make deploy\n</code></pre></p> </li> </ol>"},{"location":"#project-structure","title":"Project Structure","text":"<pre><code>event-driven-gcp/\n\u251c\u2500\u2500 api/                      # FastAPI application\n\u2502   \u251c\u2500\u2500 routers/             # API endpoints\n\u2502   \u251c\u2500\u2500 models/              # Pydantic models\n\u2502   \u251c\u2500\u2500 docs/                # OpenAPI documentation\n\u2502   \u2514\u2500\u2500 utils/               # Configuration and utilities\n\u251c\u2500\u2500 infra/                   # Terraform infrastructure\n\u2502   \u251c\u2500\u2500 modules/             # Reusable Terraform modules\n\u2502   \u2502   \u251c\u2500\u2500 cloud-dns/       # Cloud DNS Zone &amp; Records\n\u2502   \u2502   \u251c\u2500\u2500 cloud-domains/   # Domain Registration\n\u2502   \u2502   \u251c\u2500\u2500 gke-cluster/     # GKE Standard Cluster\n\u2502   \u2502   \u251c\u2500\u2500 network/         # VPC, Subnets, Global IP\n\u2502   \u2502   \u251c\u2500\u2500 security/        # SSL Policies\n\u2502   \u2502   \u2514\u2500\u2500 service-accounts/# IAM &amp; Service Accounts\n\u2502   \u2514\u2500\u2500 backend/             # Terraform backend configs\n\u251c\u2500\u2500 tests/                   # Test suite\n\u2514\u2500\u2500 docs/                    # MkDocs documentation\n</code></pre>"},{"location":"#gke-standard-cluster-infrastructure","title":"GKE Standard Cluster Infrastructure \ud83c\udfd7\ufe0f","text":"<p>This project now includes a production-ready GKE Standard cluster setup via Terraform.</p>"},{"location":"#features_1","title":"Features","text":"<ul> <li>GKE Standard: Best-practice cluster with separate node pools.</li> <li>Global Networking: VPC-native cluster with specific subnets.</li> <li>Cloud DNS: Automatic DNS zone management.</li> <li>Cloud Domains: Optional automated domain registration via Terraform.</li> <li>Security: Least-privilege IAM for GKE Service Accounts (GCS, BigQuery).</li> <li>Ingress: Global Load Balancing with Managed SSL Certificates (<code>ManagedCertificate</code>).</li> </ul>"},{"location":"#deployment-guide","title":"Deployment Guide","text":"<ol> <li> <p>Initialize Terraform <pre><code>make init_local_terraform\n</code></pre></p> </li> <li> <p>Configure Variables     Edit <code>infra/terraform/tfvars/local.tfvars</code> with your project ID and Contact Info (Required for Cloud Domains).</p> </li> <li> <p>Plan &amp; Apply (Production) <pre><code># Select Production Workspace\nterraform workspace select default\n\nmake plan_local_terraform\nmake apply_local_terraform\n</code></pre></p> <p>For Ephemeral Environments, the CI/CD pipeline handles workspace selection automatically based on the branch name.</p> </li> <li> <p>Deploy Kubernetes Manifests <pre><code>make apply_k8s\n</code></pre></p> </li> </ol>"},{"location":"#critical-warning-infrastructure-destruction","title":"\u26a0\ufe0f Critical Warning: Infrastructure Destruction","text":"<p>[!WARNING] Manual Deletion Required for Cloud Domains Terraform is configured to abandon the <code>google_clouddomains_registration</code> resource upon destruction to prevent accidental loss of domain ownership. You must delete the Domain and DNS Zone manually in the Google Cloud Console if you wish to stop billing/ownership. Terraform will NOT delete them.</p>"},{"location":"#troubleshooting-ingress","title":"Troubleshooting Ingress \ud83d\udd75\ufe0f\u200d\u2642\ufe0f","text":"<p>If you see a <code>502 Bad Gateway</code> or <code>Server Error</code>: 1.  Check Backends: <code>kubectl describe ingress</code> -&gt; Check <code>Backends</code>.     *   If <code>Unknown/Unhealthy</code>: It's usually a Health Check failure. 2.  Port Mismatch: Ensure your Service <code>targetPort</code> matches the Container port.     *   Example: App listens on <code>8080</code>, Service must target <code>8080</code>. 3.  Labels: Ensure Service <code>selector</code> matches Deployment <code>labels</code>.</p>"},{"location":"#api-endpoints","title":"API Endpoints","text":""},{"location":"#post-apiv1ingest_event","title":"<code>POST /api/v1/ingest_event</code>","text":"<p>Ingests CloudEvents from Pub/Sub into Delta Lake.</p> <p>Request Example: <pre><code>{\n  \"message\": {\n    \"data\": \"eyJuYW1lIjogIkpvaG4iLCAibGFzdG5hbWUiOiAiRG9lIn0=\",\n    \"messageId\": \"123456789\",\n    \"publishTime\": \"2025-11-24T10:00:00Z\"\n  }\n}\n</code></pre></p> <p>Response: <pre><code>{\n  \"status\": \"success\",\n  \"message_data\": \"{\\\"name\\\": \\\"John\\\", \\\"lastname\\\": \\\"Doe\\\"}\"\n}\n</code></pre></p>"},{"location":"#configuration","title":"Configuration","text":""},{"location":"#environment-variables","title":"Environment Variables","text":"<pre><code>BUCKET_NAME=\"event-driven\"           # GCS bucket name for Delta Lake\nAPI_V1_STR=\"/api/v1\"                # API prefix\nGCP_PROJECT_ID=\"dataascode\"         # GCP project ID\nLOGFIRE_SECRET_NAME=\"LOGFIRE_TOKEN_EVENT_DRIVEN_TEMPLATE\"  # Secret Manager secret name\n</code></pre>"},{"location":"#google-secret-manager","title":"Google Secret Manager","text":"<p>The Logfire token is securely stored in Google Secret Manager and retrieved at runtime:</p> <pre><code>from api.utils.secrets import get_secret_from_gcp\n\nlogfire_token = get_secret_from_gcp(\n    project_id=settings.GCP_PROJECT_ID,\n    secret_name=settings.LOGFIRE_SECRET_NAME,\n)\n</code></pre>"},{"location":"#unique-id-generation","title":"Unique ID Generation","text":"<p>Events are deduplicated using content-based hashing to prevent duplicate ingestion:</p> <pre><code>def generate_unique_id(data: dict) -&gt; str:\n    \"\"\"Generate deterministic ID from event content.\"\"\"\n    sorted_data = json.dumps(data, sort_keys=True)\n    return hashlib.sha256(sorted_data.encode()).hexdigest()\n</code></pre> <p>This ensures that: - \u2705 Same content = same ID (idempotent) - \u2705 Different content = different ID - \u2705 No duplicates even if re-published</p>"},{"location":"#development","title":"Development","text":""},{"location":"#code-quality","title":"Code Quality","text":"<pre><code># Run linting\nmake check\n\n# Format code\nuv run ruff format .\n\n# Type checking\nuv run mypy .\n</code></pre>"},{"location":"#testing","title":"Testing","text":"<pre><code># Run all tests\nmake test\n\n# Run with coverage\nmake test-cov\n</code></pre>"},{"location":"#contributing","title":"Contributing","text":"<p>See CONTRIBUTING.md for development guidelines.</p>"},{"location":"#license","title":"License","text":"<p>This project is licensed under the MIT License - see the LICENSE file for details.</p>"},{"location":"#cicd-pipeline","title":"CI/CD Pipeline","text":"<p>The project uses GitHub Actions for automated deployment:</p>"},{"location":"#docker-image-tags","title":"Docker Image Tags","text":"<p>Each build creates multiple Docker image tags: - <code>{SHA}</code> - Git commit short SHA (7 characters) - <code>{YYYYMMDD-HHMMSS}</code> - Build timestamp - <code>latest</code> - Latest successful build</p>"},{"location":"#deployment-flow","title":"Deployment Flow","text":"<ol> <li>Build &amp; Test: Run tests and type checking</li> <li>Terraform: Deploy Artifact Registry</li> <li>Docker: Build and push multi-tag image</li> <li>Deploy: Update Cloud Run service</li> <li>Documentation: Deploy MkDocs to GitHub Pages</li> </ol>"},{"location":"#iam-security","title":"IAM &amp; Security","text":""},{"location":"#service-accounts","title":"Service Accounts","text":"<p>Cloud Run Runtime (<code>cloudrun-runtime-{env}</code>): - <code>roles/secretmanager.secretAccessor</code> - Access secrets - <code>roles/storage.objectAdmin</code> - Read/write GCS objects - <code>roles/bigquery.jobUser</code> - Run BigQuery jobs</p> <p>Eventarc Triggers (<code>eventarc-triggers-{env}</code>): - <code>roles/eventarc.eventReceiver</code> - Receive events - <code>roles/run.invoker</code> - Invoke Cloud Run - <code>roles/pubsub.subscriber</code> - Subscribe to topics</p>"},{"location":"#secret-management","title":"Secret Management","text":"<p>Sensitive credentials are stored in Google Secret Manager: <pre><code># Create secret\necho -n \"your-logfire-token\" | gcloud secrets create LOGFIRE_TOKEN_EVENT_DRIVEN_TEMPLATE --data-file=-\n\n# Grant access\ngcloud secrets add-iam-policy-binding LOGFIRE_TOKEN_EVENT_DRIVEN_TEMPLATE \\\n  --member=\"serviceAccount:cloudrun-runtime-dev@PROJECT_ID.iam.gserviceaccount.com\" \\\n  --role=\"roles/secretmanager.secretAccessor\"\n</code></pre></p>"},{"location":"#technology-stack","title":"Technology Stack","text":"<ul> <li>API: FastAPI - Modern async Python web framework</li> <li>Storage: Delta Lake - ACID-compliant data lake</li> <li>Data Processing: Polars - Lightning-fast DataFrame library</li> <li>Cloud: Google Cloud Platform - Serverless infrastructure</li> <li>Observability: Logfire - Real-time monitoring</li> <li>IaC: Terraform - Infrastructure as Code</li> <li>CI/CD: GitHub Actions - Automated deployment</li> </ul>"},{"location":"#acknowledgments","title":"Acknowledgments","text":"<ul> <li>Built with FastAPI</li> <li>Storage powered by Delta Lake</li> <li>Data processing with Polars</li> <li>Deployed on Google Cloud Platform</li> <li>Observability with Logfire</li> </ul>"},{"location":"configuration-sync/","title":"Configuration Sync","text":""},{"location":"configuration-sync/#source-of-truth-configyaml","title":"Source of Truth: <code>config.yaml</code>","text":"<p>The <code>config.yaml</code> file at the project root is the source of truth for shared values. The CI/CD workflow automatically parses it using <code>yq</code>.</p> <pre><code># Central project configuration\ngcp:\n  project_id: dataascode\n  region: europe-west1\n\ngke:\n  cluster_name: template-gke-cluster\n\nartifactory:\n  repository_id: docker-repository\n\napp:\n  image_name: event-driven\n  service_name: event-driven-api  # Must match fullnameOverride in values.yaml\n</code></pre> <p>\u26a0\ufe0f The following files must be manually synchronized with <code>config.yaml</code>:</p> <ul> <li><code>infra/terraform/tfvars/main.tfvars</code></li> <li><code>infra/terraform/tfvars/local.tfvars</code></li> <li><code>infra/helm/values.yaml</code></li> </ul>"},{"location":"configuration-sync/#mapping-table","title":"Mapping Table","text":"Value <code>.github/workflows/main.yml</code> <code>infra/terraform/tfvars/main.tfvars</code> <code>infra/helm/values.yaml</code> Project ID <code>GCP_PROJECT_ID: dataascode</code> <code>project = \"dataascode\"</code> - Region <code>GCP_ZONE: europe-west1</code> <code>region = \"europe-west1\"</code> - Cluster Name <code>GKE_CLUSTER_NAME: template-gke-cluster</code> <code>gke_cluster_name = \"template-gke-cluster\"</code> - Artifact Repository <code>REPO_ARTIFACTORY: docker-repository</code> <code>artifactory_repository_id = \"docker-repository\"</code> - K8s Service Name - <code>eventarc_service_name = \"event-driven-api\"</code> <code>fullnameOverride: \"event-driven-api\"</code>"},{"location":"configuration-sync/#temporal-cloud-configuration","title":"Temporal Cloud Configuration","text":"Value Location Description TEMPORAL_ADDRESS <code>api/utils/config.py</code> Temporal Cloud endpoint TEMPORAL_NAMESPACE <code>api/utils/config.py</code> Temporal namespace TEMPORAL_API_KEY Google Secret Manager API key for authentication"},{"location":"configuration-sync/#file-details","title":"File Details","text":""},{"location":"configuration-sync/#githubworkflowsmainyml","title":"<code>.github/workflows/main.yml</code>","text":"<pre><code>env:\n  GCP_PROJECT_ID: dataascode          # \u2192 main.tfvars: project\n  GCP_ZONE: europe-west1              # \u2192 main.tfvars: region\n  REPO_ARTIFACTORY: docker-repository # \u2192 main.tfvars: artifactory_repository_id\n  GKE_CLUSTER_NAME: template-gke-cluster # \u2192 main.tfvars: gke_cluster_name\n</code></pre>"},{"location":"configuration-sync/#infraterraformtfvarsmaintfvars","title":"<code>infra/terraform/tfvars/main.tfvars</code>","text":"<pre><code>project = \"dataascode\"                      # \u2192 main.yml: GCP_PROJECT_ID\nregion  = \"europe-west1\"                    # \u2192 main.yml: GCP_ZONE\ngke_cluster_name = \"template-gke-cluster\"   # \u2192 main.yml: GKE_CLUSTER_NAME\nartifactory_repository_id = \"docker-repository\" # \u2192 main.yml: REPO_ARTIFACTORY\neventarc_service_name = \"event-driven-api\"  # \u2192 values.yaml: fullnameOverride\n\n# Event pipelines - add new topics/triggers here\nevent_pipelines = {\n  ingest = {\n    topic_name = \"event-ingestion\"\n    path       = \"/api/v1/ingest_event\"\n    label      = \"event-driven-ingest\"\n  }\n}\n</code></pre>"},{"location":"configuration-sync/#infrahelmvaluesyaml","title":"<code>infra/helm/values.yaml</code>","text":"<pre><code>fullnameOverride: \"event-driven-api\"  # \u2192 main.tfvars: eventarc_service_name\n</code></pre>"},{"location":"configuration-sync/#modification-checklist","title":"Modification Checklist","text":""},{"location":"configuration-sync/#change-gcp-project-name","title":"Change GCP Project Name","text":"<ul> <li>[ ] <code>.github/workflows/main.yml</code> \u2192 <code>GCP_PROJECT_ID</code></li> <li>[ ] <code>infra/terraform/tfvars/main.tfvars</code> \u2192 <code>project</code></li> <li>[ ] <code>infra/terraform/tfvars/local.tfvars</code> \u2192 <code>project</code></li> </ul>"},{"location":"configuration-sync/#change-region","title":"Change Region","text":"<ul> <li>[ ] <code>.github/workflows/main.yml</code> \u2192 <code>GCP_ZONE</code></li> <li>[ ] <code>infra/terraform/tfvars/main.tfvars</code> \u2192 <code>region</code></li> <li>[ ] <code>infra/terraform/tfvars/local.tfvars</code> \u2192 <code>region</code></li> </ul>"},{"location":"configuration-sync/#change-gke-cluster-name","title":"Change GKE Cluster Name","text":"<ul> <li>[ ] <code>.github/workflows/main.yml</code> \u2192 <code>GKE_CLUSTER_NAME</code></li> <li>[ ] <code>infra/terraform/tfvars/main.tfvars</code> \u2192 <code>gke_cluster_name</code></li> <li>[ ] <code>infra/terraform/tfvars/local.tfvars</code> \u2192 <code>gke_cluster_name</code></li> </ul>"},{"location":"configuration-sync/#change-artifact-registry-repository-name","title":"Change Artifact Registry Repository Name","text":"<ul> <li>[ ] <code>.github/workflows/main.yml</code> \u2192 <code>REPO_ARTIFACTORY</code></li> <li>[ ] <code>infra/terraform/tfvars/main.tfvars</code> \u2192 <code>artifactory_repository_id</code></li> <li>[ ] <code>infra/terraform/tfvars/local.tfvars</code> \u2192 <code>artifactory_repository_id</code></li> </ul>"},{"location":"configuration-sync/#change-kubernetes-service-name","title":"Change Kubernetes Service Name","text":"<ul> <li>[ ] <code>infra/terraform/tfvars/main.tfvars</code> \u2192 <code>eventarc_service_name</code></li> <li>[ ] <code>infra/terraform/tfvars/local.tfvars</code> \u2192 <code>eventarc_service_name</code></li> <li>[ ] <code>infra/helm/values.yaml</code> \u2192 <code>fullnameOverride</code></li> </ul>"},{"location":"configuration-sync/#important-notes","title":"\u26a0\ufe0f Important Notes","text":"<ol> <li> <p>K8s service name (<code>eventarc_service_name</code> / <code>fullnameOverride</code>) must be identical because Eventarc uses this name to route events to the correct service.</p> </li> <li> <p>Artifact Registry repository must exist before pushing Docker images.</p> </li> <li> <p>GKE cluster must exist before Helm deployment.</p> </li> </ol>"},{"location":"infrastructure/","title":"Infrastructure (Terraform) \ud83c\udfd7\ufe0f","text":"<p>The infrastructure is managed as code (IaC) using Terraform. It follows a modular design to ensure reusability, consistency, and separation of concerns.</p>"},{"location":"infrastructure/#global-infrastructure-schema","title":"Global Infrastructure Schema","text":"<pre><code>graph TD\n    subgraph GCP[\"GCP Project: dataascode\"]\n        subgraph NetLayer[\"Network Layer\"]\n            VPC[\"VPC Network\"]\n            Subnet[\"Subnet (k8s-subnet)\"]\n            ExtIP[\"Global Static IP\"]\n            CloudDNS[\"Cloud DNS Zone\"]\n\n            VPC --&gt; Subnet\n            ExtIP -.-&gt;|Link| CloudDNS\n        end\n\n        subgraph ComputeLayer[\"Compute Layer\"]\n            GKE[\"GKE Standard Cluster\"]\n            NodePools[\"Node Pools\"]\n\n            Subnet --&gt; GKE\n            GKE --&gt; NodePools\n        end\n\n        subgraph SecurityLayer[\"Security Layer\"]\n            SSL[\"SSL Policy\"]\n            Armor[\"Cloud Armor Policy\"]\n            IAM[\"Service Accounts\"]\n        end\n\n        subgraph EventLayer[\"Event-Driven Layer\"]\n            PubSub[\"Pub/Sub Topics\"]\n            Eventarc[\"Eventarc Triggers\"]\n\n            PubSub --&gt; Eventarc\n            Eventarc -.-&gt;|Triggers| GKE\n        end\n\n        subgraph AppLayer[\"App Support\"]\n            Artifact[\"Artifact Registry\"]\n            Domains[\"Cloud Domains\"]\n        end\n    end\n\n    subgraph External[\"External Services\"]\n        Temporal[\"Temporal Cloud\"]\n    end\n\n    GKE -.-&gt;|Workflows| Temporal\n\n    style VPC fill:#e1f5fe,stroke:#01579b\n    style GKE fill:#e8f5e9,stroke:#2e7d32\n    style PubSub fill:#fff3e0,stroke:#ff6f00\n    style Temporal fill:#f3e5f5,stroke:#7b1fa2</code></pre>"},{"location":"infrastructure/#module-dependencies","title":"Module Dependencies","text":"<p>The Terraform configuration is split into functional layers.</p> <pre><code>graph LR\n    Network[module.network] --&gt; GKE[module.gke-cluster]\n    Network --&gt; CloudDNS[module.cloud-dns]\n\n    ServiceAccount[module.service-account] --&gt; GKE\n    ServiceAccount --&gt; Eventarc[module.eventarc]\n\n    PubSub[module.pubsub] --&gt; Eventarc\n\n    GKE --&gt; Eventarc\n\n    CloudDNS --&gt; Domains[module.cloud-domains]</code></pre>"},{"location":"infrastructure/#detailed-modules","title":"Detailed Modules","text":""},{"location":"infrastructure/#1-core-networking-modulesnetwork","title":"1. Core Networking (<code>modules/network</code>)","text":"<ul> <li>VPC: Custom VPC network (not using default).</li> <li>Subnet: Specific subnet (<code>10.0.0.0/24</code>) with secondary ranges for Pods and Services (VPC-native).</li> <li>Global Address: Reserves a static external IP (<code>google_compute_global_address</code>) used by the Ingress Controller.</li> </ul>"},{"location":"infrastructure/#2-compute-modulesgke-cluster","title":"2. Compute (<code>modules/gke-cluster</code>)","text":"<ul> <li>Cluster: GKE Standard regional cluster.</li> <li>Node Pools: Dedicated node pools (e.g., <code>primary-pool</code>).</li> <li>Security:</li> <li>Workload Identity enabled.</li> <li>Shielded Nodes enabled.</li> <li>Private nodes (no external IPs on nodes).</li> </ul>"},{"location":"infrastructure/#3-dns-domains-modulescloud-dns-modulescloud-domains","title":"3. DNS &amp; Domains (<code>modules/cloud-dns</code>, <code>modules/cloud-domains</code>)","text":"<ul> <li>Cloud DNS: Manages the managed zone <code>templatejojotest.com</code>.</li> <li>A Records: Automatically maps the Global Static IP to the domain root.</li> <li>Cloud Domains: (Optional) Handles domain registration and directs name servers to Cloud DNS.</li> </ul>"},{"location":"infrastructure/#4-event-driven-modulespubsub-moduleseventarc","title":"4. Event Driven (<code>modules/pubsub</code>, <code>modules/eventarc</code>)","text":"<ul> <li>Pub/Sub: Creates topics (<code>event-ingestion</code>) and subscriptions.</li> <li>Eventarc: Creates triggers that listen to Pub/Sub messages and forward them to the GKE Service (<code>event-driven-api</code>).<ul> <li>Note: Requires the GKE Service to be exposed internally or via Cloud Run for Anthos (here using native GKE destinations).</li> </ul> </li> </ul>"},{"location":"infrastructure/#5-security-iam-modulessecurity-modulesservice-accounts","title":"5. Security &amp; IAM (<code>modules/security</code>, <code>modules/service-accounts</code>)","text":"<ul> <li>Service Accounts:</li> <li><code>cloudrun-runtime</code>: Used by Pods (Workload Identity).</li> <li><code>eventarc-triggers</code>: Used by Eventarc to invoke the service.</li> <li>SSL Policy: Enforces TLS 1.2+ configuration for the Load Balancer.</li> </ul>"},{"location":"infrastructure/#6-temporal-cloud-external-service","title":"6. Temporal Cloud (External Service)","text":"<ul> <li>Durable Workflows: Orchestrates long-running business processes with automatic retries.</li> <li>Ephemeral Workers: Workers are created per-request and destroyed after execution for efficient resource usage.</li> <li>Configuration:</li> <li><code>TEMPORAL_ADDRESS</code>: Temporal Cloud endpoint (e.g., <code>europe-west3.gcp.api.temporal.io:7233</code>)</li> <li><code>TEMPORAL_NAMESPACE</code>: Your Temporal namespace</li> <li><code>TEMPORAL_API_KEY</code>: Stored in Google Secret Manager</li> </ul>"},{"location":"infrastructure/#architecture-strategy","title":"Architecture Strategy \ud83e\udde0","text":""},{"location":"infrastructure/#shared-cluster-topology","title":"Shared Cluster Topology","text":"<p>To optimize costs and provisioning time, we use a Shared Cluster strategy:</p> <ul> <li>Production (<code>default</code> workspace): Owns the \"Physical\" layer (VPC, GKE Cluster, DNS Zone).</li> <li>Ephemeral Workspaces (e.g., <code>feat-login</code>): Read the existing infrastructure via Terraform Data Sources. They Only deploy Logical isolated resources (Pub/Sub Topics, Eventarc Triggers).</li> </ul> <pre><code>graph TD\n    subgraph ProdWorkspace[\"Production Workspace\"]\n        VPC[\"VPC Network\"]\n        GKE[\"GKE Cluster\"]\n        DNS[\"Cloud DNS\"]\n        ProdEvents[\"Prod Eventarc &amp; PubSub\"]\n    end\n\n    subgraph FeatWorkspace[\"Ephemeral Workspace: feat-xyz\"]\n        DataSources[\"Data Sources (Read-Only)\"] -.-&gt; VPC\n        DataSources -.-&gt; GKE\n        FeatEvents[\"Ephemeral Eventarc &amp; PubSub\"]\n    end\n\n    style ProdWorkspace fill:#e1f5fe,stroke:#01579b\n    style FeatWorkspace fill:#fff3e0,stroke:#ff6f00</code></pre>"},{"location":"infrastructure/#deployment","title":"Deployment \ud83d\ude80","text":""},{"location":"infrastructure/#manual-deployment","title":"Manual Deployment","text":"<pre><code># 1. Initialize\nmake init_local_terraform\n\n# 2. Select Workspace (Critical!)\n# For Prod:\nterraform workspace select default\n\n# For Feature Dev:\nterraform workspace new feat-my-feature || terraform workspace select feat-my-feature\n\n# 3. Plan &amp; Apply\nmake plan_local_terraform\nmake apply_local_terraform\n</code></pre>"},{"location":"infrastructure/#cicd-automation","title":"CI/CD Automation","text":"<p>References to workspaces are handled automatically by GitHub Actions: *   Main Branch \u2192 Selects <code>default</code> workspace. *   Feature Branches \u2192 Selects/Creates <code>feat-&lt;branch-name&gt;</code> workspace.</p>"},{"location":"kubernetes/","title":"Kubernetes &amp; Ingress \u2638\ufe0f","text":""},{"location":"kubernetes/#global-architecture","title":"Global Architecture","text":"<p>The architecture relies on GKE Standard for container orchestration, coupled with GCE Ingress for global traffic management and Workload Identity for secure GCP access.</p> <pre><code>graph TD\n    user((\"User\")) --&gt;|HTTPS| GSLB[\"Global Load Balancer\"]\n\n    subgraph GCP[\"Google Cloud Platform\"]\n        GSLB --&gt;|\"Managed Cert\"| SSL{\"SSL Termination\"}\n        SSL --&gt;|HTTP| Backend[\"Backend Service\"]\n\n        subgraph GKECluster[\"GKE Cluster\"]\n            Backend --&gt;|\"NodePort\"| Service[\"K8s Service\"]\n\n            subgraph Workloads[\"Workloads\"]\n                Service --&gt;|\"Selector\"| Pod1[\"API Pod 1\"]\n                Service --&gt;|\"Selector\"| Pod2[\"API Pod 2\"]\n            end\n\n            HPA[\"HPA\"] -.-&gt;|\"CPU &gt; 80%\"| Workloads\n\n            Pod1 -.-&gt;|\"Workload Identity\"| GSA[\"GCP Service Account\"]\n        end\n\n        GSA --&gt;|IAM| SecretMgr[\"Secret Manager\"]\n        GSA --&gt;|IAM| BigQuery[\"BigQuery\"]\n        GSA --&gt;|IAM| GCS[\"Cloud Storage\"]\n    end\n\n    style GSLB fill:#4285f4,stroke:#fff,color:#fff\n    style GKECluster fill:#34a853,stroke:#fff,color:#fff\n    style Workloads fill:#e6f4ea,stroke:#34a853</code></pre>"},{"location":"kubernetes/#detailed-components","title":"Detailed Components","text":""},{"location":"kubernetes/#1-ingress-gce-l7-load-balancer","title":"1. Ingress (GCE L7 Load Balancer)","text":"<p>We use the Google Cloud native Ingress controller (<code>gce</code>), which provisions a Global External HTTP(S) Load Balancer.</p> <ul> <li>Managed Certificate (<code>ManagedCertificate</code>): Automatically provisions and renews Google-managed SSL certificates.<ul> <li>Domain: <code>templatejojotest.com</code> (Production)</li> <li>Status Check: <code>kubectl get managedcertificate</code> (State should be <code>ACTIVE</code>).</li> </ul> </li> <li>FrontendConfig: Controls the Load Balancer frontend behavior.<ul> <li>HTTP-to-HTTPS Redirect: Enforced automatically.</li> <li>SSL Policy: Uses a modern SSL policy (TLS 1.2+).</li> </ul> </li> <li>BackendConfig: Controls backend configuration.<ul> <li>Health Checks: Custom health check path (<code>/</code>) and timeout settings.</li> <li>Cloud Armor: (Optional) WAF integration.</li> <li>Connection Draining: Timeout ensuring graceful shutdowns.</li> </ul> </li> </ul>"},{"location":"kubernetes/#2-workload-identity-security","title":"2. Workload Identity (Security)","text":"<p>We do not use JSON keys. We use Workload Identity to map Kubernetes Service Accounts (KSA) to Google Service Accounts (GSA).</p> <pre><code>sequenceDiagram\n    participant Pod\n    participant MetadataServer\n    participant IAM\n\n    Pod-&gt;&gt;MetadataServer: Request Token (audience: gcp)\n    MetadataServer-&gt;&gt;IAM: Exchange K8s Token for GCP Token\n    IAM--&gt;&gt;MetadataServer: Valid GCP Access Token\n    MetadataServer--&gt;&gt;Pod: GCP Access Token\n    Pod-&gt;&gt;GCS: Access Bucket (Authorized)</code></pre> <p>Configuration steps: 1.  GCP: Create GSA (<code>gke-sa@project.iam.gserviceaccount.com</code>). 2.  IAM: Grant <code>roles/iam.workloadIdentityUser</code> to <code>serviceAccount:project.svc.id.goog[namespace/ksa-name]</code>. 3.  K8s: Annotate KSA with <code>iam.gke.io/gcp-service-account: gke-sa@...</code>.</p>"},{"location":"kubernetes/#3-scaling-hpa","title":"3. Scaling (HPA)","text":"<p>The Horizontal Pod Autoscaler (HPA) automatically adjusts the number of pods based on CPU utilization.</p> <ul> <li>Metric: <code>targetCPUUtilizationPercentage: 80</code></li> <li>Min Replicas: <code>1</code> (Can be raised for prod high-availability)</li> <li>Max Replicas: <code>10</code></li> <li>Behavior: When average CPU across pods exceeds 80% of the Requested CPU, new replicas are added.</li> </ul>"},{"location":"kubernetes/#deployment-strategy","title":"Deployment Strategy","text":""},{"location":"kubernetes/#production-default-namespace","title":"Production (<code>default</code> namespace)","text":"<ul> <li>DNS: <code>templatejojotest.com</code></li> <li>Certificate: Production Managed Certificate.</li> <li>Ingress: Static IP reservation (<code>google_compute_global_address</code>).</li> </ul>"},{"location":"kubernetes/#ephemeral-environments-feat-","title":"\u26a1 Ephemeral Environments (<code>feat-*</code>)","text":"<ul> <li>Namespace: Dynamic (e.g., <code>feat-login</code>).</li> <li>Routing:<ul> <li>Deployed via Helm.</li> <li>Uses the same Ingress Controller but differentiates via Traffic Splitting (if configuring Istio) or separate Ingress resources (if configuring distinct hostnames).</li> <li>Current Setup: Deploys a separate Ingress. Note that creating multiple GCE Ingresses can take time (~5-10 mins) for LB provisioning.</li> </ul> </li> </ul>"},{"location":"kubernetes/#troubleshooting","title":"Troubleshooting \ud83d\udee0\ufe0f","text":""},{"location":"kubernetes/#502-bad-gateway","title":"\u26a0\ufe0f 502 Bad Gateway","text":"<p>This is the most common error with GCE Ingress.</p> Cause Verification Fix Pod Startup <code>kubectl get pods</code> Wait for <code>Running</code> state (Probe success). Health Check <code>kubectl describe ingress</code> Check <code>Backends</code> section for <code>Unhealthy</code>. Firewall <code>gcloud compute firewall-rules list</code> Ensure GFE IPs (130.211.0.0/22, 35.191.0.0/16) can reach Nodes. TargetPort <code>kubectl get svc</code> Service <code>targetPort</code> must match Pod <code>containerPort</code>."},{"location":"kubernetes/#403-permission-denied-gcp","title":"\u26a0\ufe0f 403 Permission Denied (GCP)","text":"<p>If the pod cannot access GCS or Secret Manager:</p> <ol> <li>Check Annotation:     <pre><code>kubectl get sa -n &lt;namespace&gt; &lt;sa-name&gt; -o yaml\n# Look for: iam.gke.io/gcp-service-account\n</code></pre></li> <li>Check Binding:     <pre><code>gcloud iam service-accounts get-iam-policy &lt;gsa-email&gt;\n# Look for: roles/iam.workloadIdentityUser bound to the correct K8s SA.\n</code></pre></li> </ol>"},{"location":"kubernetes/#certificate-provisioning-fails","title":"\u26a0\ufe0f Certificate Provisioning Fails","text":"<ul> <li>Check DNS: The domain must point to the Ingress static IP. Google won't provision the cert if DNS validation fails.</li> <li>Check Quota: Ensure you haven't exceeded SSL cert quotas.</li> </ul>"}]}